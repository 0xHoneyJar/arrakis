// Sietch Unified - Prisma Schema
// PostgreSQL database for permanent user identity mapping

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// IDENTITY MODELS
// =============================================================================

/// Unified Identity - The "Diplomatic Passport"
/// Bridges Discord/Telegram UIDs to verified wallet addresses
model UnifiedIdentity {
  id            String   @id @default(uuid())
  primaryWallet String   @unique @map("primary_wallet")
  
  // Cached conviction data for quick lookups
  tier          String   @default("none")
  rank          Int?
  
  // Relations
  wallets        LinkedWallet[]
  accounts       LinkedAccount[]
  profile        UserProfile?
  sessions       VerificationSession[]
  activityScore  ActivityScore?
  badgePurchases UserBadgePurchase[]
  boosts         CommunityBoost[]
  
  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("unified_identities")
}

/// Linked wallet addresses
model LinkedWallet {
  id                   String   @id @default(uuid())
  address              String   @unique
  chain                String   @default("ethereum")
  isPrimary            Boolean  @default(false) @map("is_primary")
  verifiedAt           DateTime @map("verified_at")
  verificationMethod   String   @map("verification_method") // 'signature' | 'collabland' | 'manual'
  
  // Relations
  unifiedIdentityId    String   @map("unified_identity_id")
  unifiedIdentity      UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt            DateTime @default(now()) @map("created_at")

  @@index([unifiedIdentityId])
  @@map("linked_wallets")
}

/// Linked social accounts (Discord, Telegram)
model LinkedAccount {
  id                String   @id @default(uuid())
  platform          String   // 'discord' | 'telegram'
  platformId        String   @map("platform_id")
  username          String?
  metadata          Json?
  linkedAt          DateTime @map("linked_at")
  verifiedAt        DateTime? @map("verified_at")
  
  // Relations
  unifiedIdentityId String   @map("unified_identity_id")
  unifiedIdentity   UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)
  
  @@unique([platform, platformId])
  @@index([unifiedIdentityId])
  @@index([platform, platformId])
  @@map("linked_accounts")
}

// =============================================================================
// PROFILE / SOCIAL MODELS
// =============================================================================

/// User Profile (pseudonymous)
model UserProfile {
  id                String   @id @default(uuid())
  nym               String   @unique  // Pseudonymous name
  bio               String?  @db.Text
  avatar            String?  // IPFS hash or URL
  visibility        String   @default("members_only") // 'public' | 'members_only' | 'private'
  
  // Conviction data (denormalized for quick access)
  tier              String   @default("none")
  rank              Int      @default(0)
  activityScore     Float    @default(0) @map("activity_score")
  
  // Tenure tracking
  joinedAt          DateTime @default(now()) @map("joined_at")
  lastActiveAt      DateTime @default(now()) @map("last_active_at")
  
  // Platform-specific data
  discordData       Json?    @map("discord_data")
  telegramData      Json?    @map("telegram_data")
  
  // Relations
  unifiedIdentityId String   @unique @map("unified_identity_id")
  unifiedIdentity   UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)
  badges            UserBadge[]
  activities        ActivityEntry[]
  
  // Timestamps
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@index([tier])
  @@index([activityScore])
  @@map("user_profiles")
}

/// User badges
model UserBadge {
  id          String   @id @default(uuid())
  type        String   @map("badge_type")  // Used in code as 'type'
  name        String
  description String?
  earnedAt    DateTime @map("earned_at")
  metadata    Json?
  
  // Relations
  profileId   String   @map("profile_id")
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  @@unique([profileId, type])
  @@index([profileId])
  @@index([type])
  @@map("user_badges")
}

// =============================================================================
// ACTIVITY TRACKING
// =============================================================================

/// Activity tracking for demurrage model
model ActivityEntry {
  id          String   @id @default(uuid())
  platform    String   // 'discord' | 'telegram'
  actionType  String   @map("action_type") // 'message' | 'reaction' | 'voice' | 'command'
  points      Float    @default(1)
  channelId   String?  @map("channel_id")
  metadata    Json?
  timestamp   DateTime @default(now())
  
  // Relations
  profileId   String   @map("profile_id")
  profile     UserProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([timestamp])
  @@index([platform])
  @@map("activity_entries")
}

/// Activity decay log (for auditing demurrage application)
model ActivityDecayLog {
  id              String   @id @default(uuid())
  profileId       String   @map("profile_id")
  previousScore   Float    @map("previous_score")
  newScore        Float    @map("new_score")
  decayRate       Float    @map("decay_rate")
  appliedAt       DateTime @default(now()) @map("applied_at")

  @@index([profileId])
  @@index([appliedAt])
  @@map("activity_decay_logs")
}

// =============================================================================
// CONVICTION CACHE
// =============================================================================

/// Cached conviction evaluations
model ConvictionCache {
  id                    String   @id @default(uuid())
  walletAddress         String   @unique @map("wallet_address")
  tier                  String
  rank                  Int
  totalScore            Float    @map("total_score")
  metrics               Json     // Detailed metric breakdown
  eligible              Boolean
  disqualificationReason String?  @map("disqualification_reason")
  evaluatedAt           DateTime @map("evaluated_at")
  expiresAt             DateTime @map("expires_at")
  
  @@index([tier])
  @@index([expiresAt])
  @@map("conviction_cache")
}

// =============================================================================
// ROLE SYNC / HANDSHAKE
// =============================================================================

/// Role sync events for audit trail
model RoleSyncEvent {
  id                String   @id @default(uuid())
  unifiedIdentityId String   @map("unified_identity_id")
  previousTier      String   @map("previous_tier")
  newTier           String   @map("new_tier")
  platforms         String[] // Array of platforms synced
  reason            String   // 'eligibility_change' | 'manual' | 'handshake'
  metadata          Json?
  timestamp         DateTime @default(now())

  @@index([unifiedIdentityId])
  @@index([timestamp])
  @@map("role_sync_events")
}

/// Verification sessions (for handshake flow)
model VerificationSession {
  id                String   @id @default(uuid())
  platform          String
  platformId        String   @map("platform_id")
  platformUsername  String?  @map("platform_username")
  walletAddress     String?  @map("wallet_address")
  nonce             String?  @unique
  message           String?
  status            String   @default("pending") // 'pending' | 'completed' | 'expired'
  expiresAt         DateTime @map("expires_at")
  completedAt       DateTime? @map("completed_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  // Link to identity once verified
  identityId        String?  @map("identity_id")
  identity          UnifiedIdentity? @relation(fields: [identityId], references: [id])

  @@index([platform, platformId])
  @@index([nonce])
  @@index([expiresAt])
  @@map("verification_sessions")
}

// =============================================================================
// ADMIN / CONFIG
// =============================================================================

/// Server configuration per community
model CommunityConfig {
  id                String   @id @default(uuid())
  discordServerId   String?  @unique @map("discord_server_id")
  telegramChatId    String?  @unique @map("telegram_chat_id")
  name              String
  convictionConfig  Json     @map("conviction_config") // Parsed YAML config
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("community_configs")
}

/// API keys for admin endpoints
model ApiKey {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  permissions String[] // Array of allowed operations
  isActive    Boolean  @default(true) @map("is_active")
  lastUsedAt  DateTime? @map("last_used_at")
  expiresAt   DateTime? @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("api_keys")
}

// =============================================================================
// BILLING & SUBSCRIPTIONS
// =============================================================================

/// Fee waiver for complimentary access (owner-granted)
model FeeWaiver {
  id                String    @id @default(uuid())
  communityId       String    @unique @map("community_id")
  
  // Waiver details
  tier              String    @default("enterprise") // Tier to grant (typically enterprise for full access)
  reason            String                           // Why waiver was granted
  grantedBy         String    @map("granted_by")     // Owner/admin who granted
  
  // Optional expiration (null = permanent)
  expiresAt         DateTime? @map("expires_at")
  
  // Internal notes
  internalNotes     String?   @map("internal_notes")
  
  // Status
  isActive          Boolean   @default(true) @map("is_active")
  revokedAt         DateTime? @map("revoked_at")
  revokedBy         String?   @map("revoked_by")
  revocationReason  String?   @map("revocation_reason")
  
  // Timestamps
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([expiresAt])
  @@map("fee_waivers")
}

// =============================================================================
// SIETCH SCORE BADGE
// =============================================================================

/// User badge purchase for Sietch Score display
/// Users can purchase individually if their community tier doesn't include it
model UserBadgePurchase {
  id                  String    @id @default(uuid())
  unifiedIdentityId   String    @map("unified_identity_id")
  
  // Badge type
  badgeType           String    @default("sietch_score") @map("badge_type")
  
  // Purchase details (null if granted via tier or waiver)
  stripePaymentId     String?   @unique @map("stripe_payment_id")
  amountPaid          Int?      @map("amount_paid")  // In cents
  currency            String?   @default("usd")
  purchaseMethod      String    @map("purchase_method") // 'stripe', 'tier_included', 'waiver_granted', 'admin_granted'
  
  // Display settings
  isDisplayEnabled    Boolean   @default(true) @map("is_display_enabled")
  displayOnDiscord    Boolean   @default(true) @map("display_on_discord")
  displayOnTelegram   Boolean   @default(true) @map("display_on_telegram")
  
  // Badge customization
  badgeStyle          String    @default("default") @map("badge_style") // 'default', 'minimal', 'detailed'
  
  // Validity
  isActive            Boolean   @default(true) @map("is_active")
  expiresAt           DateTime? @map("expires_at")  // null = permanent
  
  // Timestamps
  purchasedAt         DateTime  @default(now()) @map("purchased_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  identity            UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)

  @@unique([unifiedIdentityId, badgeType])
  @@index([badgeType])
  @@index([isActive])
  @@map("user_badge_purchases")
}

/// Badge display cache for quick lookups by bots
model BadgeDisplayCache {
  id                  String    @id @default(uuid())
  
  // Platform lookup keys
  platform            String    // 'discord' | 'telegram'
  platformId          String    @map("platform_id")
  
  // Cached badge info
  badgeType           String    @map("badge_type")
  displayText         String    @map("display_text")  // e.g., "⚡ 847" or "Sietch: 847 | Fedaykin"
  badgeEmoji          String    @default("⚡") @map("badge_emoji")
  convictionScore     Int       @map("conviction_score")
  tier                String    // naib, fedaykin, none
  
  // Display enabled
  isEnabled           Boolean   @default(true) @map("is_enabled")
  
  // Cache metadata
  cachedAt            DateTime  @default(now()) @map("cached_at")
  expiresAt           DateTime  @map("expires_at")

  @@unique([platform, platformId, badgeType])
  @@index([platform, platformId])
  @@index([expiresAt])
  @@map("badge_display_cache")
}

// =============================================================================
// COMMUNITY BOOSTS (Discord-style collective funding)
// =============================================================================

/// Individual boost from a user to a community
model CommunityBoost {
  id                  String    @id @default(uuid())
  communityId         String    @map("community_id")
  unifiedIdentityId   String    @map("unified_identity_id")
  
  // Stripe subscription for the boost
  stripeSubscriptionId String?  @unique @map("stripe_subscription_id")
  stripeCustomerId    String?   @map("stripe_customer_id")
  
  // Boost details
  boostCount          Int       @default(1) @map("boost_count")  // User can buy multiple boosts
  status              String    @default("active")               // active, past_due, cancelled
  
  // Billing period
  currentPeriodStart  DateTime  @map("current_period_start")
  currentPeriodEnd    DateTime  @map("current_period_end")
  
  // Timestamps
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  cancelledAt         DateTime? @map("cancelled_at")
  
  // Relations
  identity            UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)

  @@unique([communityId, unifiedIdentityId])
  @@index([communityId])
  @@index([status])
  @@map("community_boosts")
}

/// Cached boost level for a community (computed from active boosts)
model CommunityBoostLevel {
  id                  String    @id @default(uuid())
  communityId         String    @unique @map("community_id")
  
  // Current boost state
  totalBoosts         Int       @default(0) @map("total_boosts")
  activeBoosterCount  Int       @default(0) @map("active_booster_count")
  boostLevel          Int       @default(0) @map("boost_level")  // 0, 1, 2, 3
  effectiveTier       String    @default("starter") @map("effective_tier")
  
  // Level history (for perks that require sustained level)
  reachedLevel1At     DateTime? @map("reached_level1_at")
  reachedLevel2At     DateTime? @map("reached_level2_at")
  reachedLevel3At     DateTime? @map("reached_level3_at")
  
  // Cache metadata
  lastCalculatedAt    DateTime  @default(now()) @map("last_calculated_at")
  
  @@map("community_boost_levels")
}

/// Community subscription record
model CommunitySubscription {
  id                    String    @id @default(uuid())
  communityId           String    @unique @map("community_id")
  
  // Stripe identifiers
  stripeCustomerId      String    @map("stripe_customer_id")
  stripeSubscriptionId  String    @unique @map("stripe_subscription_id")
  
  // Subscription details
  tier                  String    @default("starter") // starter, basic, premium, exclusive, elite, enterprise
  status                String    @default("active")  // active, past_due, cancelled, trialing
  
  // Billing period
  currentPeriodStart    DateTime  @map("current_period_start")
  currentPeriodEnd      DateTime  @map("current_period_end")
  
  // Grace period for failed payments
  graceUntil            DateTime? @map("grace_until")
  
  // Cancellation tracking
  cancelledAt           DateTime? @map("cancelled_at")
  cancellationReason    String?   @map("cancellation_reason")
  
  // Admin who created the subscription
  createdByUserId       String?   @map("created_by_user_id")
  
  // Timestamps
  createdAt             DateTime  @default(now()) @map("created_at")
  updatedAt             DateTime  @updatedAt @map("updated_at")
  
  // Relations
  paymentHistory        PaymentHistory[]
  subscriptionEvents    SubscriptionEvent[]

  @@index([tier])
  @@index([status])
  @@index([stripeCustomerId])
  @@map("community_subscriptions")
}

/// Payment history for auditing
model PaymentHistory {
  id                String   @id @default(uuid())
  communityId       String   @map("community_id")
  
  // Stripe invoice details
  stripeInvoiceId   String   @unique @map("stripe_invoice_id")
  amount            Int      // Amount in cents
  currency          String   @default("usd")
  status            String   // succeeded, failed, refunded
  
  // Failure details
  failureReason     String?  @map("failure_reason")
  
  // Timestamps
  paidAt            DateTime? @map("paid_at")
  createdAt         DateTime @default(now()) @map("created_at")
  
  // Relations
  subscription      CommunitySubscription @relation(fields: [communityId], references: [communityId], onDelete: Cascade)

  @@index([communityId])
  @@index([status])
  @@map("payment_history")
}

/// Subscription lifecycle events
model SubscriptionEvent {
  id            String   @id @default(uuid())
  communityId   String   @map("community_id")
  eventType     String   @map("event_type") // tier_changed, subscription_cancelled, grace_started, etc.
  previousTier  String?  @map("previous_tier")
  newTier       String?  @map("new_tier")
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at")
  
  // Relations
  subscription  CommunitySubscription @relation(fields: [communityId], references: [communityId], onDelete: Cascade)

  @@index([communityId])
  @@index([eventType])
  @@map("subscription_events")
}

/// Stripe webhook event tracking (idempotency)
model WebhookEvent {
  id            String   @id @default(uuid())
  stripeEventId String   @unique @map("stripe_event_id")
  eventType     String   @map("event_type")
  processedAt   DateTime @map("processed_at")
  
  @@index([stripeEventId])
  @@map("webhook_events")
}

/// Audit log for admin actions
model AuditLog {
  id        String   @id @default(uuid())
  action    String
  actor     String   // 'admin', 'system', or user ID
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

/// User profile for directory and preferences
model UserProfile {
  id                String          @id @default(uuid())
  unifiedIdentityId String          @unique @map("unified_identity_id")
  nym               String?         @unique
  badges            Json?           // Array of badge IDs
  preferences       Json?           // User preferences object
  
  unifiedIdentity   UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  @@map("user_profiles")
}

// =============================================================================
// CONVICTION & ACTIVITY
// =============================================================================

/// Conviction score snapshots for history
model ConvictionSnapshot {
  id            String   @id @default(uuid())
  walletAddress String   @map("wallet_address")
  score         Int
  rank          Int
  tier          String
  components    Json?    // { holdings, governance, engagement }
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([walletAddress])
  @@index([createdAt])
  @@map("conviction_snapshots")
}

/// Activity scores with decay tracking
model ActivityScore {
  id                String          @id @default(uuid())
  unifiedIdentityId String          @unique @map("unified_identity_id")
  score             Int             @default(0)
  lastActivityAt    DateTime?       @map("last_activity_at")
  lastDecayAt       DateTime?       @map("last_decay_at")
  
  unifiedIdentity   UnifiedIdentity @relation(fields: [unifiedIdentityId], references: [id], onDelete: Cascade)
  
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")

  @@map("activity_scores")
}
